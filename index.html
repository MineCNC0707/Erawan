<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>Erawan 仓库管理系统</title>
    <!-- 引入字体和图标 -->
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap"
      rel="stylesheet" />
    <link
      href="https://cdn.jsdelivr.net/npm/remixicon@3.5.0/fonts/remixicon.css"
      rel="stylesheet" />
    <!-- 引入 Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

    <link rel="icon" type="image/png" href="./logo.png" />
    <link rel="stylesheet" href="style.css" />
  </head>
  <body>
    <div class="app-wrapper">
      <!-- 侧边栏 -->
      <aside class="sidebar no-print">
        <div class="logo-area">
          <div class="logo-icon"><i class="ri-store-3-fill"></i></div>
          <span class="logo-text">Erawan</span>
        </div>

        <nav class="nav-menu">
          <div class="nav-label">核心运营</div>
          <button class="nav-item active" onclick="switchTab('reports')">
            <i class="ri-dashboard-3-line"></i> <span>仪表盘</span>
          </button>
          <button class="nav-item" onclick="switchTab('outbound')">
            <i class="ri-logout-box-r-line"></i> <span>出货管理 (Out)</span>
          </button>
          <button class="nav-item" onclick="switchTab('purchase')">
            <i class="ri-truck-line"></i> <span>进货入库 (In)</span>
          </button>

          <div class="nav-label" style="margin-top: 20px">库存监控</div>
          <button class="nav-item" onclick="switchTab('storeroom')">
            <i class="ri-building-2-line"></i> <span>仓库看板</span>
          </button>
          <button class="nav-item" onclick="switchTab('inventory')">
            <i class="ri-archive-drawer-line"></i> <span>总库存表</span>
          </button>

          <div class="nav-label" style="margin-top: 20px">设置</div>
          <button class="nav-item" onclick="switchTab('products')">
            <i class="ri-database-2-line"></i> <span>商品档案</span>
          </button>
        </nav>

        <div class="sidebar-footer">
          <button class="nav-item secondary" onclick="exportData()">
            <i class="ri-download-cloud-2-line"></i> <span>备份数据</span>
          </button>
          <button
            class="nav-item secondary"
            onclick="document.getElementById('importFile').click()">
            <i class="ri-upload-cloud-2-line"></i> <span>恢复数据</span>
          </button>
          <input
            type="file"
            id="importFile"
            hidden
            onchange="importData(this)"
            accept=".json" />
        </div>
      </aside>

      <!-- 移动端侧边栏遮罩 -->
      <div class="sidebar-overlay" onclick="toggleSidebar()"></div>

      <!-- 主内容区 -->
      <main class="main-content">
        <header class="top-bar no-print">
          <button class="mobile-menu-btn" onclick="toggleSidebar()">
            <i class="ri-menu-line"></i>
          </button>

          <h2 id="pageTitle">仪表盘</h2>
          <div class="user-profile">
            <span class="date-display" id="currentDate"></span>
            <div class="avatar"><i class="ri-user-3-line"></i></div>
          </div>
        </header>

        <div class="content-body">
          <!-- 1. 仪表盘 -->
          <div id="reports" class="view-section active">
            <div class="stats-grid">
              <div class="stat-card orange">
                <div class="icon-box"><i class="ri-logout-box-r-line"></i></div>
                <div class="stat-info">
                  <h4>今日出货 (销售额)</h4>
                  <div class="value" id="todayOut">RM 0.00</div>
                </div>
              </div>
              <div class="stat-card blue">
                <div class="icon-box"><i class="ri-download-2-line"></i></div>
                <div class="stat-info">
                  <h4>今日进货 (成本)</h4>
                  <div class="value" id="todayIn">RM 0.00</div>
                </div>
              </div>
              <div class="stat-card purple">
                <div class="icon-box">
                  <i class="ri-calendar-check-line"></i>
                </div>
                <div class="stat-info">
                  <h4>本月累计销售</h4>
                  <div class="value" id="monthOut">RM 0.00</div>
                </div>
              </div>
              <div class="stat-card green">
                <div class="icon-box"><i class="ri-safe-2-line"></i></div>
                <div class="stat-info">
                  <h4>库存总值 (成本)</h4>
                  <div class="value" id="stockValue">RM 0.00</div>
                </div>
              </div>
            </div>

            <div class="card chart-card">
              <div class="card-header">
                <h3>出入库趋势 (In/Out Trend)</h3>
                <div class="chart-actions">
                  <button
                    class="btn btn-xs active"
                    onclick="renderTrendChart('week')">
                    本周
                  </button>
                  <button
                    class="btn btn-xs"
                    onclick="renderTrendChart('month')">
                    本月
                  </button>
                </div>
              </div>
              <div class="chart-box" style="height: 320px; padding: 10px">
                <canvas id="trendChart"></canvas>
              </div>
            </div>
          </div>

          <!-- 2. 出货管理 -->
          <div id="outbound" class="view-section">
            <div class="pos-layout">
              <div class="pos-left">
                <div class="card">
                  <div class="card-header">
                    <h3>
                      <i
                        class="ri-shopping-cart-2-line"
                        style="color: #1677ff"></i>
                      新增出货单
                    </h3>
                  </div>
                  <div class="pos-form" style="padding: 20px">
                    <div
                      class="form-row"
                      style="
                        background: #f8fafc;
                        padding: 15px;
                        border-radius: 12px;
                        border: 1px solid #e2e8f0;
                        margin-bottom: 20px;
                      ">
                      <div class="form-group" style="margin: 0">
                        <label>时间</label>
                        <input type="datetime-local" id="outboundTime" />
                      </div>
                      <div class="form-group" style="margin: 0">
                        <label>来源仓库</label>
                        <select
                          id="outboundStoreroom"
                          onchange="updateProductList()"></select>
                      </div>
                    </div>

                    <div class="form-group">
                      <label>商品搜索 (名称/编号)</label>
                      <div
                        id="outboundSearchWrapper"
                        class="custom-select-wrapper">
                        <input
                          type="text"
                          placeholder="输入关键字..."
                          autocomplete="off" />
                        <input type="hidden" />
                      </div>
                    </div>

                    <div class="form-row" style="align-items: flex-end">
                      <div class="form-group">
                        <label>单位</label>
                        <select
                          id="outboundUnitType"
                          onchange="onOutboundUnitChange()"></select>
                      </div>
                      <div class="form-group" style="display: none">
                        <input
                          type="number"
                          id="outboundUnitMultiplier"
                          value="1" />
                      </div>
                      <!-- 新增：出货价输入 -->
                      <div class="form-group">
                        <label>出货单价 (RM)</label>
                        <input
                          type="number"
                          id="outboundSellingPrice"
                          step="0.01"
                          placeholder="0.00" />
                      </div>
                      <div class="form-group">
                        <label>数量</label>
                        <div class="number-input-group">
                          <button type="button" onclick="adjQty(-1)">-</button>
                          <input
                            type="number"
                            id="outboundQuantityInput"
                            min="1"
                            value="1" />
                          <button type="button" onclick="adjQty(1)">+</button>
                        </div>
                      </div>
                    </div>

                    <div class="form-group">
                      <label>备注/客户</label>
                      <input
                        type="text"
                        id="outboundRemark"
                        placeholder="可选..." />
                    </div>

                    <button
                      type="button"
                      class="btn btn-primary btn-block btn-lg"
                      onclick="addOutboundItem()">
                      <i class="ri-add-circle-line"></i> 加入列表
                    </button>
                  </div>
                </div>

                <div class="card mt-4">
                  <div class="card-header">
                    <h3>最近出货记录</h3>
                    <div class="search-box">
                      <i class="ri-search-line"></i>
                      <input
                        type="text"
                        placeholder="搜索..."
                        onkeyup="searchTable('outboundTableBody', this.value)" />
                    </div>
                  </div>
                  <div class="table-responsive">
                    <table class="table">
                      <thead>
                        <tr>
                          <th>时间</th>
                          <th>仓库</th>
                          <th>商品</th>
                          <th>数量</th>
                          <th>出货单价</th>
                          <th>销售总额</th>
                          <th>操作</th>
                        </tr>
                      </thead>
                      <tbody id="outboundTableBody"></tbody>
                    </table>
                  </div>
                </div>
              </div>

              <div class="pos-right">
                <div class="card receipt-card">
                  <div class="receipt-header">
                    <h3><i class="ri-list-check"></i> 待出货清单</h3>
                    <span
                      class="badge"
                      id="outboundCount"
                      style="background: #fff; color: #f97316"
                      >0 项</span
                    >
                  </div>
                  <div class="receipt-body" id="outboundItemsContainer">
                    <div class="empty-cart">
                      <i class="ri-clipboard-line"></i>
                      <p>清单为空</p>
                    </div>
                  </div>
                  <div
                    class="receipt-footer"
                    id="outboundFooter"
                    style="display: none">
                    <div class="receipt-actions">
                      <button
                        class="btn btn-danger btn-light"
                        onclick="clearOutboundItems()">
                        清空
                      </button>
                      <button
                        class="btn btn-success"
                        style="background: #f97316; border-color: #f97316"
                        onclick="confirmOutbound()">
                        <i class="ri-check-double-line"></i> 确认出货
                      </button>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- 3. 进货管理 -->
          <div id="purchase" class="view-section">
            <div class="card">
              <div class="card-header">
                <h3><i class="ri-add-box-line"></i> 快速进货入库</h3>
              </div>
              <form
                id="purchaseForm"
                onsubmit="quickPurchase(event)"
                class="inline-form">
                <div class="form-group">
                  <label>时间</label
                  ><input
                    type="datetime-local"
                    id="purchaseTimeInput"
                    required />
                </div>
                <div class="form-group">
                  <label>存入仓库</label
                  ><select id="purchaseStoreroom" required></select>
                </div>
                <div class="form-group grow-2">
                  <label>商品</label>
                  <div id="purchaseSearchWrapper" class="custom-select-wrapper">
                    <input
                      type="text"
                      placeholder="搜索或输入新商品..."
                      required
                      autocomplete="off" />
                    <input type="hidden" />
                  </div>
                </div>
                <!-- 新增：单位选择 -->
                <div class="form-group" style="min-width: 80px">
                  <label>单位</label>
                  <select id="purchaseUnitType">
                    <option value="piece">个</option>
                  </select>
                </div>
                <div class="form-group">
                  <label>数量</label
                  ><input
                    type="number"
                    id="purchaseQuantity"
                    min="1"
                    required />
                </div>
                <div class="form-group">
                  <label>单价/箱价(RM)</label
                  ><input
                    type="number"
                    id="purchasePrice"
                    step="0.01"
                    required />
                </div>
                <div class="form-group action-col">
                  <label>&nbsp;</label>
                  <button type="submit" class="btn btn-primary">
                    <i class="ri-download-line"></i> 入库
                  </button>
                </div>
              </form>
            </div>

            <div class="card mt-4">
              <div class="card-header">
                <h3>进货记录</h3>
                <div class="search-box">
                  <i class="ri-search-line"></i>
                  <input
                    type="text"
                    placeholder="搜索..."
                    onkeyup="searchTable('purchaseTableBody', this.value)" />
                </div>
              </div>
              <div class="table-responsive">
                <table>
                  <thead>
                    <tr>
                      <th>时间</th>
                      <th>仓库</th>
                      <th>商品</th>
                      <th>数量 (箱/个)</th>
                      <th>单价</th>
                      <th>总额</th>
                      <th>操作</th>
                    </tr>
                  </thead>
                  <tbody id="purchaseTableBody"></tbody>
                </table>
              </div>
            </div>
          </div>

          <!-- 4. 仓库监控 -->
          <div id="storeroom" class="view-section">
            <div class="tips-box">
              <i class="ri-lightbulb-line"></i>
              点击卡片右上角的编辑图标可修改仓库名称。
            </div>
            <div class="store-cards">
              <!-- Store Cards 1-5 -->
              <div class="store-card active" onclick="loadStoreroomDetail(1)">
                <div class="card-top">
                  <h5 id="st1-name">Store 1</h5>
                  <i
                    class="ri-edit-line edit-icon"
                    onclick="renameStoreroom(event, 1)"></i>
                </div>
                <div class="store-stat">
                  <span>库存:</span><b id="st1-qty">0</b>
                </div>
                <div class="store-stat">
                  <span>价值:</span><b id="st1-val" class="text-blue">RM 0</b>
                </div>
              </div>
              <div class="store-card" onclick="loadStoreroomDetail(2)">
                <div class="card-top">
                  <h5 id="st2-name">Store 2</h5>
                  <i
                    class="ri-edit-line edit-icon"
                    onclick="renameStoreroom(event, 2)"></i>
                </div>
                <div class="store-stat">
                  <span>库存:</span><b id="st2-qty">0</b>
                </div>
                <div class="store-stat">
                  <span>价值:</span><b id="st2-val" class="text-blue">RM 0</b>
                </div>
              </div>
              <div class="store-card" onclick="loadStoreroomDetail(3)">
                <div class="card-top">
                  <h5 id="st3-name">Store 3</h5>
                  <i
                    class="ri-edit-line edit-icon"
                    onclick="renameStoreroom(event, 3)"></i>
                </div>
                <div class="store-stat">
                  <span>库存:</span><b id="st3-qty">0</b>
                </div>
                <div class="store-stat">
                  <span>价值:</span><b id="st3-val" class="text-blue">RM 0</b>
                </div>
              </div>
              <div class="store-card" onclick="loadStoreroomDetail(4)">
                <div class="card-top">
                  <h5 id="st4-name">Store 4</h5>
                  <i
                    class="ri-edit-line edit-icon"
                    onclick="renameStoreroom(event, 4)"></i>
                </div>
                <div class="store-stat">
                  <span>库存:</span><b id="st4-qty">0</b>
                </div>
                <div class="store-stat">
                  <span>价值:</span><b id="st4-val" class="text-blue">RM 0</b>
                </div>
              </div>
              <div class="store-card" onclick="loadStoreroomDetail(5)">
                <div class="card-top">
                  <h5 id="st5-name">Store 5</h5>
                  <i
                    class="ri-edit-line edit-icon"
                    onclick="renameStoreroom(event, 5)"></i>
                </div>
                <div class="store-stat">
                  <span>库存:</span><b id="st5-qty">0</b>
                </div>
                <div class="store-stat">
                  <span>价值:</span><b id="st5-val" class="text-blue">RM 0</b>
                </div>
              </div>
            </div>

            <!-- 手动调整 -->
            <div class="card mb-4" style="border-left: 4px solid #10b981">
              <div class="card-header">
                <h3><i class="ri-equalizer-line"></i> 手动库存调整</h3>
              </div>
              <div class="card-body" style="padding: 20px">
                <form
                  onsubmit="manualUpdateStock(event)"
                  class="inline-form"
                  style="padding: 0">
                  <div class="form-group">
                    <label>仓库</label
                    ><select
                      id="manageStoreroomId"
                      onchange="updateProductList()"
                      required></select>
                  </div>
                  <div class="form-group grow-2">
                    <label>商品</label>
                    <div id="manageSearchWrapper" class="custom-select-wrapper">
                      <input
                        type="text"
                        placeholder="搜索商品..."
                        required
                        autocomplete="off" />
                      <input type="hidden" />
                    </div>
                    <small
                      id="currentStockDisplay"
                      style="color: #64748b"></small>
                  </div>
                  <div class="form-group">
                    <label>增减数量 (+/-)</label
                    ><input
                      type="number"
                      id="manageQuantity"
                      required
                      placeholder="如: 10 或 -5" />
                  </div>
                  <div class="form-group grow-2">
                    <label>备注</label
                    ><input
                      type="text"
                      id="manageRemark"
                      placeholder="如: 破损/盘点" />
                  </div>
                  <div class="form-group action-col">
                    <label>&nbsp;</label>
                    <button type="submit" class="btn btn-success">确认</button>
                    <button
                      type="button"
                      class="btn btn-danger"
                      onclick="clearCurrentStock()">
                      清零
                    </button>
                  </div>
                </form>
              </div>
            </div>

            <!-- 详情表 -->
            <div class="card">
              <div class="card-header">
                <h3 id="currentStoreTitle">仓库详情</h3>
                <div class="search-box">
                  <i class="ri-search-line"></i
                  ><input
                    type="text"
                    placeholder="搜索..."
                    onkeyup="searchTable('storeroomTableBody', this.value)" />
                </div>
              </div>
              <div class="table-responsive">
                <table>
                  <thead>
                    <tr>
                      <th>商品</th>
                      <th>分类</th>
                      <th>批次</th>
                      <th>当前库存</th>
                      <th>成本</th>
                      <th>备注</th>
                    </tr>
                  </thead>
                  <tbody id="storeroomTableBody"></tbody>
                </table>
              </div>
            </div>
          </div>

          <!-- 5. 库存总览 -->
          <div id="inventory" class="view-section">
            <div class="card">
              <div class="card-header">
                <h3>所有库存分布</h3>
                <div class="search-box">
                  <i class="ri-search-line"></i
                  ><input
                    type="text"
                    placeholder="搜索..."
                    onkeyup="searchTable('inventoryTableBody', this.value)" />
                </div>
              </div>
              <div class="table-responsive">
                <table>
                  <thead>
                    <tr>
                      <th>商品</th>
                      <th>分类</th>
                      <th>总库存(双单位)</th>
                      <th>分布 (Store 1-5)</th>
                      <th>成本</th>
                      <th>状态</th>
                    </tr>
                  </thead>
                  <tbody id="inventoryTableBody"></tbody>
                </table>
              </div>
            </div>
          </div>

          <!-- 6. 商品管理 -->
          <div id="products" class="view-section">
            <div class="split-layout">
              <div class="card form-panel">
                <div class="card-header">
                  <h3><i class="ri-edit-2-line"></i> 编辑/新增商品</h3>
                </div>
                <form
                  id="productForm"
                  onsubmit="saveProduct(event)"
                  style="padding: 20px">
                  <input type="hidden" id="editProductId" />
                  <div class="form-grid">
                    <div class="form-group span-2">
                      <label>名称</label
                      ><input type="text" id="productName" required />
                    </div>
                    <div class="form-group">
                      <label>分类</label>
                      <div class="input-group-row">
                        <select id="productCategory" required></select>
                        <button
                          type="button"
                          class="btn btn-outline"
                          onclick="openCategoryModal()">
                          <i class="ri-settings-4-line"></i>
                        </button>
                      </div>
                    </div>
                    <div class="form-group">
                      <label>进价(RM)</label
                      ><input
                        type="number"
                        id="productCostPrice"
                        step="0.01"
                        required />
                    </div>

                    <!-- 单位设置 -->
                    <div
                      class="form-group span-2"
                      style="
                        background: #f8fafc;
                        padding: 15px;
                        border-radius: 12px;
                        border: 1px dashed #cbd5e1;
                      ">
                      <label
                        style="
                          color: #1677ff;
                          font-weight: 600;
                          margin-bottom: 10px;
                          display: block;
                        "
                        >单位设置</label
                      >
                      <div class="form-row">
                        <div class="form-group">
                          <label>小单位</label
                          ><input type="text" id="productUnitName" value="个" />
                        </div>
                        <div class="form-group">
                          <label>大单位</label
                          ><input
                            type="text"
                            id="productBoxUnitName"
                            value="箱" />
                        </div>
                        <div class="form-group">
                          <label>箱规 (1箱=多少个)</label
                          ><input
                            type="number"
                            id="productBoxSize"
                            value="1"
                            min="1" />
                        </div>
                      </div>
                    </div>

                    <div class="form-group span-2">
                      <label id="stockLabel">初始库存 (Store 1)</label>
                      <input type="number" id="productStock" value="0" />
                    </div>
                  </div>
                  <div class="form-actions" style="margin-top: 20px">
                    <button
                      type="button"
                      class="btn btn-outline"
                      onclick="resetProductForm()">
                      重置
                    </button>
                    <button type="submit" id="saveBtn" class="btn btn-primary">
                      保存商品
                    </button>
                  </div>
                </form>
              </div>

              <div class="card list-panel">
                <div class="card-header"><h3>商品列表</h3></div>
                <div
                  style="
                    padding: 10px 20px;
                    display: flex;
                    gap: 10px;
                    border-bottom: 1px solid #eee;
                  ">
                  <select
                    id="filterCategorySelect"
                    onchange="loadProducts()"
                    style="width: 140px"></select>
                  <div class="search-box" style="flex: 1">
                    <i class="ri-search-line"></i
                    ><input
                      type="text"
                      placeholder="搜索..."
                      onkeyup="searchTable('productsTableBody', this.value)" />
                  </div>
                </div>
                <div class="table-responsive" style="max-height: 600px">
                  <table>
                    <thead>
                      <tr>
                        <th>名称</th>
                        <th>分类</th>
                        <th>箱规</th>
                        <th>价格</th>
                        <th>库存</th>
                        <th>操作</th>
                      </tr>
                    </thead>
                    <tbody id="productsTableBody"></tbody>
                  </table>
                </div>
              </div>
            </div>
          </div>
        </div>
      </main>
    </div>

    <!-- 弹窗：分类管理 -->
    <div id="categoryModal" class="modal">
      <div class="modal-content">
        <div class="modal-header">
          <h3>管理分类</h3>
          <span class="close-btn" onclick="closeCategoryModal()">&times;</span>
        </div>
        <div class="modal-body" style="padding: 24px">
          <div style="display: flex; gap: 12px; margin-bottom: 20px">
            <input
              type="text"
              id="newCategoryInput"
              placeholder="新分类名称"
              style="flex: 1; height: 40px" />
            <button
              class="btn btn-primary"
              style="height: 40px"
              onclick="addNewCategory()">
              添加
            </button>
          </div>
          <div
            style="
              max-height: 300px;
              overflow-y: auto;
              border: 1px solid #f0f0f0;
              border-radius: 12px;
            ">
            <ul
              id="categoryList"
              style="list-style: none; padding: 0; margin: 0"></ul>
          </div>
        </div>
        <div class="modal-footer">
          <button class="btn btn-outline" onclick="closeCategoryModal()">
            完成
          </button>
        </div>
      </div>
    </div>

    <!-- 弹窗：小票打印 -->
    <div id="billModal" class="modal">
      <div class="modal-content receipt-modal">
        <div class="modal-header">
          <h3>单据预览</h3>
          <span class="close-btn no-print" onclick="closeBillModal()"
            >&times;</span
          >
        </div>
        <div id="billContent" class="thermal-receipt"></div>
        <div class="modal-footer no-print">
          <button class="btn btn-outline" onclick="closeBillModal()">
            关闭
          </button>
          <button class="btn btn-primary" onclick="window.print()">
            <i class="ri-printer-line"></i> 打印
          </button>
        </div>
      </div>
    </div>

    <div id="toast-container"></div>
    <!-- 引入JS文件 -->
    <script src="main.js"></script>
  </body>
</html>
